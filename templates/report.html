{% extends "base.html" %}

{% block title %}Reportes Asistencia{% endblock %}

{% block content %}
<style>
.registro-table {
    background: white;
    border-radius: 8px;
    overflow: hidden;
}

.registro-table th {
    background: #343A40;
    color: white;
    padding: 12px;
    font-weight: 600;
    text-align: center;
}

.registro-table td {
    padding: 10px;
    text-align: center;
    border-bottom: 1px solid #dee2e6;
}

.entrada-manana { background-color: #fff3cd; }
.salida-manana { background-color: #fff3cd; }
.entrada-tarde { background-color: #cfe2ff; }
.salida-tarde { background-color: #cfe2ff; }

.employee-name {
    font-weight: 600;
    text-align: left !important;
}

.fecha-actual {
    background: #f8f9fa;
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 20px;
    border-left: 4px solid #0d6efd;
}
</style>

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="header-gradient py-4 mb-4 rounded">
                <div class="container">
                    <div>
                        <h1 class="mb-0"><i class="fas fa-chart-bar me-3"></i>Reportes de Asistencia</h1>
                        <p class="mb-0">Generación y visualización de reportes mensuales por empresa</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-lg-12">
            <div class="card">
                <div class="card-header" style="background-color: #343A40; color: white;">
                    <h5 class="mb-0"><i class="fas fa-filter me-2"></i>Parámetros de Reporte</h5>
                </div>
                <div class="card-body">
                    <form id="report-form">
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label for="empresa_id" class="form-label">Empresa *</label>
                                <select class="form-select" id="empresa_id" name="empresa_id" required>
                                    <option value="">Seleccione una empresa</option>
                                    {% for empresa in empresas %}
                                    <option value="{{ empresa.id }}">{{ empresa.nombre }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            
                            <div class="col-md-3">
                                <label for="mes" class="form-label">Mes *</label>
                                <select class="form-select" id="mes" name="mes" required>
                                    <option value="">Seleccione mes</option>
                                    <option value="1">Enero</option>
                                    <option value="2">Febrero</option>
                                    <option value="3">Marzo</option>
                                    <option value="4">Abril</option>
                                    <option value="5">Mayo</option>
                                    <option value="6">Junio</option>
                                    <option value="7">Julio</option>
                                    <option value="8">Agosto</option>
                                    <option value="9">Septiembre</option>
                                    <option value="10">Octubre</option>
                                    <option value="11">Noviembre</option>
                                    <option value="12">Diciembre</option>
                                </select>
                            </div>
                            
                            <div class="col-md-3">
                                <label for="anio" class="form-label">Año *</label>
                                <select class="form-select" id="anio" name="anio" required>
                                    <option value="">Seleccione año</option>
                                    <option value="2024">2024</option>
                                    <option value="2025">2025</option>
                                </select>
                            </div>
                            
                            <div class="col-md-2 d-flex align-items-end">
                                <button type="submit" class="btn btn-primary w-100">
                                    <i class="fas fa-search me-2"></i>Generar
                                </button>
                            </div>
                            
                            <div class="col-md-12 d-flex justify-content-end mt-3">
                                <button type="button" class="btn btn-success" onclick="exportarExcel()" id="btn-exportar" style="display: none;">
                                    <i class="fas fa-file-excel me-2"></i>Exportar a Excel
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <div id="report-container">
                <div class="text-center py-5">
                    <i class="fas fa-chart-bar fa-3x text-muted mb-3"></i>
                    <h4>Seleccione los parámetros para generar el reporte</h4>
                    <p class="text-muted">Elija una empresa, mes y año para ver los reportes de asistencia</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Variables globales
let currentReportParams = {
    empresa_id: null,
    mes: null,
    anio: null
};

// Obtener fecha actual
const fechaHoy = new Date();
const diaHoy = fechaHoy.getDate();
const mesHoy = fechaHoy.getMonth() + 1;
const anioHoy = fechaHoy.getFullYear();

document.getElementById('report-form').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const empresaId = document.getElementById('empresa_id').value;
    const mes = document.getElementById('mes').value;
    const anio = document.getElementById('anio').value;
    
    if (!empresaId || !mes || !anio) {
        alert('Por favor complete todos los campos');
        return;
    }
    
    // Guardar parámetros
    currentReportParams = {
        empresa_id: empresaId,
        mes: mes,
        anio: anio
    };
    
    // Mostrar botón de exportar
    document.getElementById('btn-exportar').style.display = 'block';
    
    // Cargar reporte
    cargarReporteDiario(empresaId, mes, anio);
});

function cargarReporteDiario(empresaId, mes, anio) {
    const reportContainer = document.getElementById('report-container');
    
    reportContainer.innerHTML = `
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status"></div>
            <p class="mt-2">Cargando registros del día...</p>
        </div>
    `;
    
    // Obtener empleados de la empresa
    fetch(`/api/empleados?empresa_id=${empresaId}`)
        .then(res => res.json())
        .then(empleados => {
            mostrarRegistrosDiarios(empleados, empresaId);
        })
        .catch(error => {
            console.error('Error:', error);
            reportContainer.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Error al cargar los registros
                </div>
            `;
        });
}

function mostrarRegistrosDiarios(empleados, empresaId) {
    const reportContainer = document.getElementById('report-container');
    
    // Obtener nombre de la empresa
    const empresaSelect = document.getElementById('empresa_id');
    const empresaNombre = empresaSelect.options[empresaSelect.selectedIndex].text;
    
    // Formatear fecha actual
    const meses = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 
                   'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
    const fechaFormateada = `${diaHoy} de ${meses[mesHoy - 1]} del ${anioHoy}`;
    
    let html = `
        <div class="card">
            <div class="card-header bg-dark text-white">
                <h5 class="mb-0">
                    <i class="fas fa-calendar-day me-2"></i>
                    Registros de Hoy - ${empresaNombre}
                </h5>
            </div>
            <div class="card-body">
                <div class="fecha-actual">
                    <h6 class="mb-0">
                        <i class="fas fa-calendar me-2"></i>
                        Día ${fechaFormateada}
                    </h6>
                </div>
                
                <div class="table-responsive">
                    <table class="table registro-table">
                        <thead>
                            <tr>
                                <th>Nombre</th>
                                <th class="entrada-manana">ENTRADA MAÑANA</th>
                                <th class="salida-manana">SALIDA MAÑANA</th>
                                <th class="entrada-tarde">ENTRADA TARDE</th>
                                <th class="salida-tarde">SALIDA TARDE</th>
                            </tr>
                        </thead>
                        <tbody id="tabla-registros">
                            <tr>
                                <td colspan="5" class="text-center">
                                    <div class="spinner-border spinner-border-sm"></div>
                                    Cargando registros...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    `;
    
    reportContainer.innerHTML = html;
    
    // Cargar asistencias del día actual
    cargarAsistenciasDelDia(empleados);
}

async function cargarAsistenciasDelDia(empleados) {
    const tbody = document.getElementById('tabla-registros');
    const fechaHoy = `${anioHoy}-${String(mesHoy).padStart(2, '0')}-${String(diaHoy).padStart(2, '0')}`;
    
    let html = '';
    let hayRegistros = false;
    
    for (const empleado of empleados) {
        try {
            // Consultar asistencia del empleado para hoy
            const response = await fetch(`/api/asistencias/${empleado.id}?fecha=${fechaHoy}`);
            const asistencia = await response.json();
            
            if (asistencia && asistencia.fecha) {
                hayRegistros = true;
                html += `
                    <tr>
                        <td class="employee-name">${empleado.nombre}</td>
                        <td class="entrada-manana">${asistencia.entrada_manana_real || '-'}</td>
                        <td class="salida-manana">${asistencia.salida_manana_real || '-'}</td>
                        <td class="entrada-tarde">${asistencia.entrada_tarde_real || '-'}</td>
                        <td class="salida-tarde">${asistencia.salida_tarde_real || '-'}</td>
                    </tr>
                `;
            }
        } catch (error) {
            console.error(`Error cargando asistencia de ${empleado.nombre}:`, error);
        }
    }
    
    if (!hayRegistros) {
        html = `
            <tr>
                <td colspan="5" class="text-center text-muted py-4">
                    <i class="fas fa-info-circle me-2"></i>
                    No hay registros para el día de hoy
                </td>
            </tr>
        `;
    }
    
    tbody.innerHTML = html;
}

function exportarExcel() {
    if (!currentReportParams.empresa_id || !currentReportParams.mes || !currentReportParams.anio) {
        alert('Por favor genere un reporte primero');
        return;
    }
    
    const url = `/api/reports/export/excel?empresa_id=${currentReportParams.empresa_id}&mes=${currentReportParams.mes}&anio=${currentReportParams.anio}`;
    window.open(url, '_blank');
}
</script>
{% endblock %}