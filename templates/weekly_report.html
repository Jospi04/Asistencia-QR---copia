{% extends "base.html" %}

{% block title %}Reporte Semanal de Actividad{% endblock %}

{% block content %}

<style>
.card-stat {
    border-left: 4px solid;
    transition: all 0.3s ease;
}

.card-stat:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 16px rgba(0,0,0,0.1) !important;
}

.skeleton {
    animation: skeleton-loading 1s linear infinite alternate;
}

@keyframes skeleton-loading {
    0% { background-color: hsl(200, 20%, 80%); }
    100% { background-color: hsl(200, 20%, 95%); }
}

.fade-in {
    animation: fadeIn 0.5s;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

/* date selector visuals (blend of both styles) */
.date-selector-card {
    background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
}

.form-control:focus, .form-select:focus {
    border-color: #667eea;
    box-shadow: 0 0 0 0.15rem rgba(102, 126, 234, 0.12);

}
/* Agregar dentro del bloque <style> */

/* Eliminar bordes laterales molestos */
.list-group-item {
    border-left: none !important;
    border-right: none !important;
    transition: all 0.2s ease;
}

/* Solo mantener borde inferior sutil */
.list-group-item:not(:last-child) {
    border-bottom: 1px solid rgba(0,0,0,0.08) !important;
}

/* Eliminar borde del √∫ltimo elemento */
.list-group-item:last-child {
    border-bottom: none !important;
}

/* Mejorar el borde de color lateral */
.border-start {
    border-left-width: 4px !important;
    padding-left: 12px !important;
}

/* Hover m√°s suave */
.list-group-item:hover {
    background-color: #f8fafc;
    transform: translateX(3px);
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
}

/* Mejorar espaciado interno */
.list-group-flush .list-group-item {
    padding: 1rem 0.5rem;
}
#grafico-container {
    min-height: 400px;
    position: relative;
}

#grafico-diario {
    max-height: 380px;
}
</style>

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="header-gradient py-4 mb-4 rounded">
                <div class="container">
                    <h1 class="mb-0"><i class="fas fa-chart-line me-3"></i>Reporte Semanal de Actividad</h1>
                    <p class="mb-0">An√°lisis de comportamiento y rendimiento semanal</p>
                </div>
            </div>
        </div>
    </div>

    <!-- FILTROS: Empresa + Fecha Inicio/Fin + Atajos -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm date-selector-card">
                <div class="card-body">
                    <div class="row align-items-end">
                        <div class="col-md-4 mb-3 mb-md-0">
                            <label class="form-label fw-bold">
                                <i class="fas fa-building me-2"></i>Empresa
                            </label>
                            <select class="form-select" id="empresa-selector">
                                <option value="">Todas las empresas</option>
                                {% for empresa in empresas %}
                                <option value="{{ empresa.id }}">{{ empresa.nombre }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="col-md-3 mb-3 mb-md-0">
                            <label class="form-label fw-bold">
                                <i class="fas fa-calendar-alt me-2"></i>Fecha Inicio
                            </label>
                            <input type="date" class="form-control" id="fecha-inicio">
                        </div>

                        <div class="col-md-3 mb-3 mb-md-0">
                            <label class="form-label fw-bold">
                                <i class="fas fa-calendar-check me-2"></i>Fecha Fin
                            </label>
                            <input type="date" class="form-control" id="fecha-fin">
                        </div>

                        <div class="col-md-2">
                            <label class="form-label fw-bold">
                                <i class="fas fa-clock me-2"></i>Atajos r√°pidos
                            </label>
                            <select class="form-select" id="atajo-selector">
                                <option value="">Seleccionar per√≠odo...</option>
                                <option value="hoy">Hoy</option>
                                <option value="ayer">Ayer</option>
                                <option value="semana_actual">Esta semana</option>
                                <option value="semana_pasada">Semana pasada</option>
                                <option value="mes_actual">Este mes</option>
                                <option value="mes_pasado">Mes pasado</option>
                            </select>
                        </div>
                    </div>

                    <div class="row mt-3">
                        <div class="col-12 text-center">
                            <p class="mb-0 h6" id="periodo-texto">
                                <i class="fas fa-calendar-week me-2"></i>
                                <span class="spinner-border spinner-border-sm"></span> Cargando...
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- TARJETAS DE RESUMEN -->
    <div class="row mb-4">
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card border-0 shadow-sm h-100 card-stat" style="border-left-color: #22c55e;">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <h6 class="text-muted mb-0">Promedio Puntualidad</h6>
                        <i class="fas fa-check-circle text-success"></i>
                    </div>
                    <h2 class="mb-1 fw-bold text-success" id="promedio-puntualidad">
                        <div class="skeleton" style="width: 80px; height: 40px; border-radius: 4px;"></div>
                    </h2>
                    <small class="text-muted">Empleados puntuales</small>
                </div>
            </div>
        </div>

        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card border-0 shadow-sm h-100 card-stat" style="border-left-color: #3b82f6;">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <h6 class="text-muted mb-0">Asistencia Promedio</h6>
                        <i class="fas fa-user-check text-primary"></i>
                    </div>
                    <h2 class="mb-1 fw-bold text-primary" id="porcentaje-asistencia">
                        <div class="skeleton" style="width: 80px; height: 40px; border-radius: 4px;"></div>
                    </h2>
                    <small class="text-muted">Del total de empleados</small>
                </div>
            </div>
        </div>

        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card border-0 shadow-sm h-100 card-stat" style="border-left-color: #f59e0b;">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <h6 class="text-muted mb-0">Total Tardanzas</h6>
                        <i class="fas fa-clock text-warning"></i>
                    </div>
                    <h2 class="mb-1 fw-bold text-warning" id="total-tardanzas">
                        <div class="skeleton" style="width: 60px; height: 40px; border-radius: 4px;"></div>
                    </h2>
                    <small class="text-muted">Durante el per√≠odo</small>
                </div>
            </div>
        </div>

        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card border-0 shadow-sm h-100 card-stat" style="border-left-color: #ef4444;">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <h6 class="text-muted mb-0">Total Ausencias</h6>
                        <i class="fas fa-user-times text-danger"></i>
                    </div>
                    <h2 class="mb-1 fw-bold text-danger" id="total-faltas">
                        <div class="skeleton" style="width: 60px; height: 40px; border-radius: 4px;"></div>
                    </h2>
                    <small class="text-muted">Faltas registradas</small>
                </div>
            </div>
        </div>
    </div>

    <!-- GR√ÅFICOS -->
    <!-- GR√ÅFICOS -->
<div class="row mb-4">
    <!-- Gr√°fico de Asistencia Diaria -->
    <div class="col-lg-8 mb-4">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-header" style="background-color: #14532d; color: white;">
                <h5 class="mb-0">
                    <i class="fas fa-chart-bar me-2"></i>Asistencia Diaria
                </h5>
            </div>
            <div class="card-body" id="grafico-container" style="min-height: 400px;">
                <canvas id="grafico-diario"></canvas>
            </div>
        </div>
    </div>

    <!-- Columna derecha: Primero Rojo, luego Verde -->
    <div class="col-lg-4 mb-4">
        <!-- 1Ô∏è D√≠as con Menor Asistencia (ROJO ARRIBA) -->
        <div class="card border-0 shadow-sm mb-3">
            <div class="card-header" style="background-color: #dc2626; color: white;">
                <h6 class="mb-0">
                    <i class="fas fa-calendar-times me-2"></i>D√≠as con Menor Asistencia
                </h6>
            </div>
            <div class="card-body">
                <div id="peores-dias">
                    <div class="text-center py-3">
                        <div class="spinner-border text-danger" role="status"></div>
                        <p class="text-muted mt-2 mb-0">Procesando datos...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- 2Ô∏è Horas Frecuentes (VERDE ABAJO) -->
        <div class="card border-0 shadow-sm">
            <div class="card-header" style="background-color: #166534; color: white;">
                <h6 class="mb-0">
                    <i class="fas fa-clock me-2"></i>Horas de Ingreso M√°s Frecuentes
                </h6>
            </div>
            <div class="card-body">
                <div id="horas-frecuentes">
                    <div class="text-center py-3">
                        <div class="spinner-border text-success" role="status"></div>
                        <p class="text-muted mt-2 mb-0">Analizando horarios...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

    <!-- COMPARACI√ìN ENTRE EMPRESAS -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header" style="background-color: #0891b2; color: white;">
                    <h5 class="mb-0">
                        <i class="fas fa-building me-2"></i>Rendimiento por Empresa
                    </h5>
                </div>
                <div class="card-body">
                    <div id="comparacion-empresas">
                        <div class="text-center py-4">
                            <div class="spinner-border text-info" role="status"></div>
                            <p class="text-muted mt-2 mb-0">Comparando empresas...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- INFORMACI√ìN ADICIONAL -->
    <div class="row mb-4">
        <!-- Top Puntuales -->
        <div class="col-lg-4 mb-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header" style="background-color: #22c55e; color: white;">
                    <h6 class="mb-0">
                        <i class="fas fa-trophy me-2"></i>Top 5 M√°s Puntuales
                    </h6>
                </div>
                <div class="card-body">
                    <div id="top-puntuales">
                        <div class="text-center py-3">
                            <div class="spinner-border text-success" role="status"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Top Tardones -->
        <div class="col-lg-4 mb-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header" style="background-color: #f59e0b; color: white;">
                    <h6 class="mb-0">
                        <i class="fas fa-user-clock me-2"></i>Los M√°s Tardones üòÖ
                    </h6>
                </div>
                <div class="card-body">
                    <div id="top-tardes">
                        <div class="text-center py-3">
                            <div class="spinner-border text-warning" role="status"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Insights -->
        <div class="col-lg-4 mb-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header" style="background-color: #6366f1; color: white;">
                    <h6 class="mb-0">
                        <i class="fas fa-lightbulb me-2"></i>An√°lisis y Recomendaciones
                    </h6>
                </div>
                <div class="card-body">
                    <div id="insights">
                        <div class="skeleton mb-2" style="height: 20px; width: 100%;"></div>
                        <div class="skeleton mb-2" style="height: 20px; width: 90%;"></div>
                        <div class="skeleton" style="height: 20px; width: 80%;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- DETALLES DEL REPORTE -->
    <div class="row mb-4">
        <div class="col-lg-12 mb-3">
            <div class="card border-0 shadow-sm">
                <div class="card-header" style="background-color: #8b5cf6; color: white;">
                    <h6 class="mb-0">
                        <i class="fas fa-info-circle me-2"></i>Detalles del Reporte
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-md-3 col-6 mb-3 mb-md-0 border-end">
                            <i class="fas fa-users text-primary fa-2x mb-2"></i>
                            <h4 id="info-empleados" class="mb-0">--</h4>
                            <small class="text-muted">Total Empleados</small>
                        </div>
                        <div class="col-md-3 col-6 mb-3 mb-md-0 border-end">
                            <i class="fas fa-business-time text-success fa-2x mb-2"></i>
                            <h4 id="info-horas-extras" class="mb-0">--</h4>
                            <small class="text-muted">Horas Extras</small>
                        </div>
                        <div class="col-md-3 col-6 border-end">
                            <i class="fas fa-calendar text-info fa-2x mb-2"></i>
                            <h4 class="mb-0" id="info-dias-analizados">--</h4>
                            <small class="text-muted">D√≠as Analizados</small>
                        </div>
                        <div class="col-md-3 col-6">
                            <i class="fas fa-chart-line text-warning fa-2x mb-2"></i>
                            <h4 id="info-porcentaje" class="mb-0">--</h4>
                            <small class="text-muted">% Asistencia</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- BOTONES DE ACCI√ìN -->
    <div class="row mb-4">
        <div class="col-12 text-center">
            <a href="{{ url_for('reports') }}" class="btn btn-lg btn-outline-secondary">
                <i class="fas fa-arrow-left me-2"></i>Volver a Reportes
            </a>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
let chartDiario = null;
let isLoading = false;

// Helper: formatea fecha a yyyy-mm-dd
function formatDate(date) {
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
}

// Inicializar fechas al cargar la p√°gina: inicio = lunes de la semana actual, fin = hoy
document.addEventListener('DOMContentLoaded', function() {
    const hoy = new Date();
    const inicioSemana = new Date(hoy);
    inicioSemana.setDate(hoy.getDate() - hoy.getDay() + 1); // Lunes (asumiendo semana inicia en Lunes)
    document.getElementById('fecha-inicio').value = formatDate(inicioSemana);
    document.getElementById('fecha-fin').value = formatDate(hoy);

    // listeners: cuando cambien empresa/fechas/atajo -> recargar autom√°ticamente
    document.getElementById('empresa-selector').addEventListener('change', cargarReporteSemanalDebounced);
    document.getElementById('fecha-inicio').addEventListener('change', cargarReporteSemanalDebounced);
    document.getElementById('fecha-fin').addEventListener('change', cargarReporteSemanalDebounced);
    document.getElementById('atajo-selector').addEventListener('change', aplicarAtajo);

    // cargar al inicio
    cargarReporteSemanal();
});

// Debounce simple para evitar muchas peticiones al teclear cambiar fecha r√°pido
let debounceTimer = null;
function cargarReporteSemanalDebounced() {
    if (debounceTimer) clearTimeout(debounceTimer);
    debounceTimer = setTimeout(() => {
        cargarReporteSemanal();
        debounceTimer = null;
    }, 300);
}

function aplicarAtajo() {
    const atajo = document.getElementById('atajo-selector').value;
    const hoy = new Date();
    let inicio, fin;

    switch(atajo) {
        case 'hoy':
            inicio = fin = hoy;
            break;
        case 'ayer':
            inicio = fin = new Date(hoy);
            inicio.setDate(hoy.getDate() - 1);
            fin.setDate(hoy.getDate() - 1);
            break;
        case 'semana_actual':
            inicio = new Date(hoy);
            inicio.setDate(hoy.getDate() - hoy.getDay() + 1);
            fin = hoy;
            break;
        case 'semana_pasada':
            inicio = new Date(hoy);
            inicio.setDate(hoy.getDate() - hoy.getDay() - 6);
            fin = new Date(hoy);
            fin.setDate(hoy.getDate() - hoy.getDay());
            break;
        case 'mes_actual':
            inicio = new Date(hoy.getFullYear(), hoy.getMonth(), 1);
            fin = hoy;
            break;
        case 'mes_pasado':
            inicio = new Date(hoy.getFullYear(), hoy.getMonth() - 1, 1);
            fin = new Date(hoy.getFullYear(), hoy.getMonth(), 0);
            break;
        default:
            return;
    }

    document.getElementById('fecha-inicio').value = formatDate(inicio);
    document.getElementById('fecha-fin').value = formatDate(fin);
    document.getElementById('atajo-selector').value = '';
    cargarReporteSemanal();
}

function mostrarError(mensaje) {
    const alertDiv = document.createElement('div');
    alertDiv.className = 'alert alert-danger alert-dismissible fade show position-fixed';
    alertDiv.style.cssText = 'top: 80px; right: 20px; z-index: 9999; min-width: 300px;';
    alertDiv.innerHTML = `
        ${mensaje}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(alertDiv);
    setTimeout(() => alertDiv.remove(), 5000);
}

// --- FUNCIONES PARA LLAMADAS API Y RENDER ---
function cargarReporteSemanal() {
    if (isLoading) return;
    isLoading = true;

    const empresaId = document.getElementById('empresa-selector').value;
    const fechaInicio = document.getElementById('fecha-inicio').value;
    const fechaFin = document.getElementById('fecha-fin').value;

    if (!fechaInicio || !fechaFin) {
        mostrarError('Por favor seleccione ambas fechas');
        isLoading = false;
        return;
    }
    if (new Date(fechaInicio) > new Date(fechaFin)) {
        mostrarError('La fecha de inicio debe ser menor o igual a la fecha de fin');
        isLoading = false;
        return;
    }

    const params = new URLSearchParams();
    if (empresaId) params.append('empresa_id', empresaId);
    params.append('fecha_inicio', fechaInicio);
    params.append('fecha_fin', fechaFin);

    const queryString = params.toString();

    // 1) Summary
    fetch(`/api/weekly-report/summary?${queryString}`)
        .then(res => {
            if (!res.ok) throw new Error('Error en el servidor (summary)');
            return res.json();
        })
        .then(data => {
            if (data.error) throw new Error(data.error || 'Error al obtener resumen');

            document.getElementById('periodo-texto').classList.add('fade-in');
            document.getElementById('periodo-texto').innerHTML = `
                <i class="fas fa-calendar-week me-2"></i>
                ${data.periodo.inicio_formato} - ${data.periodo.fin_formato}
            `;
            document.getElementById('promedio-puntualidad').textContent = `${data.promedio_puntualidad}%`;
            document.getElementById('porcentaje-asistencia').textContent = `${data.porcentaje_asistencia}%`;
            document.getElementById('total-tardanzas').textContent = data.total_tardanzas;
            document.getElementById('total-faltas').textContent = data.total_faltas;
            document.getElementById('info-empleados').textContent = data.total_empleados;
            document.getElementById('info-horas-extras').textContent = data.horas_extras;
            document.getElementById('info-dias-analizados').textContent = data.dias_periodo;
            document.getElementById('info-porcentaje').textContent = `${data.porcentaje_asistencia}%`;

            generarInsights(data);
        })
        .catch(err => {
            console.error('Error cargando summary:', err);
            mostrarError('Error al cargar el resumen del reporte');
        })
        .finally(() => {
            // no hacer isLoading=false a√∫n: dejamos para cuando terminen otros fetches? 
            // pero para evitar bloqueo excesivo lo liberamos aqu√≠ para permitir nuevas peticiones si usuario cambia r√°pido.
            isLoading = false;
        });

    // 2) Daily attendance (gr√°fico)
    fetch(`/api/weekly-report/daily-attendance?${queryString}`)
        .then(res => {
            if (!res.ok) throw new Error('Error en el servidor (daily-attendance)');
            return res.json();
        })
        .then(data => {
            const ctx = document.getElementById('grafico-diario');

            if (chartDiario) chartDiario.destroy();

            chartDiario = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.dias,
                    datasets: [{
                        label: 'Asistencias',
                        data: data.asistencias,
                        backgroundColor: '#22c55e',
                        borderColor: '#16a34a',
                        borderWidth: 2
                    }, {
                        label: 'Tardanzas',
                        data: data.tardanzas,
                        backgroundColor: '#f59e0b',
                        borderColor: '#d97706',
                        borderWidth: 2
                    }, {
                        label: 'Faltas',
                        data: data.faltas,
                        backgroundColor: '#ef4444',
                        borderColor: '#dc2626',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });

        })
        .catch(err => {
            console.error('Error cargando gr√°fico:', err);
            document.getElementById('grafico-container').innerHTML = `
                <div class="alert alert-warning">No se pudo cargar el gr√°fico</div>
            `;
        });

    // 3) Frequent hours
    fetch(`/api/weekly-report/frequent-hours?${queryString}`)
        .then(res => res.json())
        .then(data => {
            document.getElementById('horas-frecuentes').innerHTML = `
                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="text-muted">
                            <i class="fas fa-sun text-warning me-2"></i>Turno Ma√±ana
                        </span>
                        <strong class="h5 mb-0">${data.hora_frecuente_manana}</strong>
                    </div>
                    <small class="text-muted">${data.frecuencia_manana} registros</small>
                </div>
                <hr>
                <div>
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="text-muted">
                            <i class="fas fa-moon text-primary me-2"></i>Turno Tarde
                        </span>
                        <strong class="h5 mb-0">${data.hora_frecuente_tarde}</strong>
                    </div>
                    <small class="text-muted">${data.frecuencia_tarde} registros</small>
                </div>
            `;
        })
        .catch(err => {
            console.error('Error cargando horas frecuentes:', err);
            document.getElementById('horas-frecuentes').innerHTML = `
                <p class="text-muted text-center mb-0">No disponible</p>
            `;
        });

    // 4) Worst days
    fetch(`/api/weekly-report/worst-days?${queryString}`)
        .then(res => res.json())
        .then(data => {
            if (!Array.isArray(data) || data.length === 0) {
                document.getElementById('peores-dias').innerHTML = `
                    <p class="text-muted text-center mb-0">Sin datos suficientes</p>
                `;
            } else {
                let html = '<div class="list-group list-group-flush">';
                data.forEach((dia) => {
                    html += `
                        <div class="list-group-item d-flex justify-content-between align-items-center px-0">
                            <div>
                                <strong>${dia.dia}</strong><br>
                                <small class="text-muted">${dia.fecha}</small>
                            </div>
                            <span class="badge bg-danger rounded-pill">${dia.asistencias}</span>
                        </div>
                    `;
                });
                html += '</div>';
                document.getElementById('peores-dias').innerHTML = html;
            }
        })
        .catch(err => {
            console.error('Error cargando peores d√≠as:', err);
            document.getElementById('peores-dias').innerHTML = `
                <p class="text-muted text-center mb-0">No disponible</p>
            `;
        });

    // 5) Companies comparison
    fetch(`/api/weekly-report/companies-comparison?${queryString}`)
        .then(res => res.json())
        .then(data => {
            if (!Array.isArray(data) || data.length === 0) {
                document.getElementById('comparacion-empresas').innerHTML = `
                    <p class="text-muted text-center mb-0">No hay datos disponibles</p>
                `;
            } else {
                let html = '<div class="table-responsive"><table class="table table-hover mb-0">';
                html += `
                    <thead class="table-light">
                        <tr>
                            <th>Empresa</th>
                            <th class="text-center">Total Empleados</th>
                            <th class="text-center">Asistencia</th>
                            <th style="width: 40%;">Rendimiento</th>
                        </tr>
                    </thead>
                    <tbody>
                `;
                data.forEach(empresa => {
                    const color = empresa.porcentaje_asistencia >= 80 ? 'success' :
                                 empresa.porcentaje_asistencia >= 60 ? 'warning' : 'danger';
                    html += `
                        <tr>
                            <td><strong>${empresa.nombre}</strong></td>
                            <td class="text-center">${empresa.total_empleados}</td>
                            <td class="text-center"><span class="badge bg-${color}">${empresa.porcentaje_asistencia}%</span></td>
                            <td>
                                <div class="progress" style="height: 25px;">
                                    <div class="progress-bar bg-${color}" role="progressbar" 
                                         style="width: ${empresa.porcentaje_asistencia}%"
                                         aria-valuenow="${empresa.porcentaje_asistencia}" 
                                         aria-valuemin="0" aria-valuemax="100">
                                        ${empresa.porcentaje_asistencia}%
                                    </div>
                                </div>
                            </td>
                        </tr>
                    `;
                });
                html += '</tbody></table></div>';
                document.getElementById('comparacion-empresas').innerHTML = html;
            }
        })
        .catch(err => {
            console.error('Error cargando comparaci√≥n:', err);
            document.getElementById('comparacion-empresas').innerHTML = `
                <div class="alert alert-warning mb-0">No se pudo cargar la comparaci√≥n</div>
            `;
        });


// 6 & 7) TOP Puntuales y TOP Tardones - VERSI√ìN CORREGIDA
fetch(`/api/weekly-report/top-punctual?${queryString}`)
    .then(r => r.json())
    .catch(() => [])
    .then(topPuntuales => {
        if (!Array.isArray(topPuntuales) || topPuntuales.length === 0) {
            document.getElementById('top-puntuales').innerHTML = `
                <div class="text-center py-4">
                    <i class="fas fa-trophy text-muted fa-3x mb-3"></i>
                    <p class="text-muted mb-0">No hay empleados con puntualidad perfecta</p>
                    <small class="text-muted">Se requiere 0 tardanzas para aparecer aqu√≠</small>
                </div>
            `;
        } else {
            let html = '<div class="list-group list-group-flush">';
            topPuntuales.forEach((emp, idx) => {
                const medal = idx === 0 ? 'ü•á' : idx === 1 ? 'ü•à' : idx === 2 ? 'ü•â' : 'üèÖ';
                html += `
                    <div class="list-group-item d-flex justify-content-between align-items-center px-0 border-start border-success border-3">
                        <div>
                            <span class="fw-bold fs-6">${medal} ${idx + 1}. ${emp.nombre}</span>
                            <span class="badge bg-success ms-2">100% Puntual</span><br>
                            <small class="text-muted">
                                <i class="fas fa-check-circle text-success me-1"></i>
                                ${emp.turnos_puntuales}/${emp.total_turnos} turnos a tiempo
                            </small>
                        </div>
                        <div class="text-end">
                            <span class="badge bg-success rounded-pill fs-5">${emp.turnos_puntuales}</span><br>
                            <small class="text-success fw-bold">Perfecto</small>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            document.getElementById('top-puntuales').innerHTML = html;
        }
    })
    .catch(err => {
        console.error('Error cargando top puntuales:', err);
        document.getElementById('top-puntuales').innerHTML = `
            <p class="text-muted text-center mb-0">Error al cargar datos</p>
        `;
    });

// TOP TARDONES
fetch(`/api/weekly-report/top-late?${queryString}`)
    .then(r => r.json())
    .catch(() => [])
    .then(topTardes => {
        if (!Array.isArray(topTardes) || topTardes.length === 0) {
            document.getElementById('top-tardes').innerHTML = `
                <div class="text-center py-4">
                    <i class="fas fa-smile-beam text-success fa-3x mb-3"></i>
                    <p class="text-success fw-bold mb-0">¬°Excelente! üéâ</p>
                    <small class="text-muted">Nadie lleg√≥ tarde en este per√≠odo</small>
                </div>
            `;
        } else {
            let html = '<div class="list-group list-group-flush">';
            topTardes.forEach((emp, idx) => {
                // Calcular porcentaje de tardanzas
                const porcentajeTarde = Math.round((emp.tardanzas / emp.total_turnos) * 100);
                
                html += `
                    <div class="list-group-item d-flex justify-content-between align-items-center px-0 border-start border-warning border-3">
                        <div>
                            <span class="fw-bold fs-6">${idx + 1}. ${emp.nombre}</span>
                            <span class="badge bg-warning text-dark ms-2">${porcentajeTarde}% tarde</span><br>
                            <small class="text-muted">
                                <i class="fas fa-clock text-warning me-1"></i>
                                ${emp.tardanzas}/${emp.total_turnos} turnos con tardanza
                            </small>
                        </div>
                        <div class="text-end">
                            <span class="badge bg-warning text-dark rounded-pill fs-5">${emp.tardanzas}</span><br>
                            <small class="text-warning">Tardanzas</small>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            document.getElementById('top-tardes').innerHTML = html;
        }
    })
    .catch(err => {
        console.error('Error cargando top tardes:', err);
        document.getElementById('top-tardes').innerHTML = `
            <p class="text-muted text-center mb-0">Error al cargar datos</p>
        `;
    });
    

}

// Generar insights (misma l√≥gica del c√≥digo 1)
function generarInsights(data) {
    let insights = '';

    if (data.promedio_puntualidad >= 90) {
        insights += '<div class="alert alert-success mb-2"><i class="fas fa-check-circle me-2"></i><strong>Excelente puntualidad:</strong> El equipo mantiene un alto nivel de puntualidad.</div>';
    } else if (data.promedio_puntualidad < 70) {
        insights += '<div class="alert alert-warning mb-2"><i class="fas fa-exclamation-triangle me-2"></i><strong>Mejorar puntualidad:</strong> Se recomienda reforzar la cultura de puntualidad.</div>';
    }

    if (data.porcentaje_asistencia >= 85) {
        insights += '<div class="alert alert-info mb-2"><i class="fas fa-thumbs-up me-2"></i><strong>Buena asistencia:</strong> La mayor√≠a del personal asiste regularmente.</div>';
    } else if (data.porcentaje_asistencia < 70) {
        insights += '<div class="alert alert-danger mb-2"><i class="fas fa-times-circle me-2"></i><strong>Asistencia baja:</strong> Se necesita investigar las causas de las ausencias.</div>';
    }

    if (data.total_tardanzas > 10) {
        insights += '<div class="alert alert-warning mb-2"><i class="fas fa-clock me-2"></i><strong>Muchas tardanzas:</strong> Considerar revisar los horarios o implementar incentivos.</div>';
    }

    if (!insights) {
        insights = '<p class="text-muted mb-0">Los indicadores est√°n dentro del rango normal. Continuar monitoreando.</p>';
    }

    document.getElementById('insights').innerHTML = insights;
}   
</script>

{% endblock %}
