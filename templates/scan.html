{% extends "base.html" %}

{% block title %}Escanear QR{% endblock %}

{% block content %}
<style>
.scanner-container {
    width: 100%;
    max-width: 300px;
    max-height: 300px;
    border: 2px dashed #ccc;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    background-color: #ffffff;
    overflow: hidden;
    margin: 0 auto;
    position: relative;
}

#scanner-video {
    width: 100%;
    height: auto;
    max-height: 100%;
    display: none;
    border-radius: 10px;
    object-fit: contain;
}

.placeholder-content {
    text-align: center;
    padding: 15px;
}

.placeholder-content i {
    font-size: 1.5rem;
}

.placeholder-content p {
    font-size: 0.8rem;
    margin: 8px 0;
}

.placeholder-content button {
    font-size: 0.8rem;
    padding: 6px 12px;
}

/* Estilo para el cuadro de escaneo */
#qr-canvas {
    width: 100% !important;
    height: auto !important;
}
</style>

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="header-gradient py-4 mb-4 rounded">
                <div class="container">
                    <h1 class="mb-0"><i class="fas fa-camera me-3"></i>Escanear Código QR</h1>
                    <p class="mb-0">Posicione el código QR del empleado frente a la cámara para registrar asistencia</p>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header" style="background-color: #14532d; color: white;">

                    <h5 class="mb-0"><i class="fas fa-video me-2"></i>Cámara de Escaneo</h5>
                </div>
                <div class="card-body">
                    <div class="text-center mb-3">
                        <div class="scanner-container" id="scanner-container">
                            <div id="scanner-placeholder" class="placeholder-content">
                                <i class="fas fa-qrcode text-muted mb-2"></i>
                                <p class="text-muted mb-2">La cámara se activará automáticamente</p>
                                <button id="start-camera" class="btn btn-primary btn-sm">
                                    <i class="fas fa-video me-1"></i>Activar Cámara
                                </button>
                            </div>
                            <video id="scanner-video" style="display: none;"></video>
                        </div>
                    </div>
                    
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Instrucciones:</strong> Mantenga el código QR del empleado dentro del marco durante unos segundos hasta que se registre la asistencia.
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-4">
            <div class="card mb-4">
                <div class="card-header" style="background-color: #14532d; color: white;">

                    <h5 class="mb-0"><i class="fas fa-clock me-2"></i>Estado del Sistema</h5>
                </div>
                <div class="card-body">
                    <div class="text-center mb-3">
                        <div id="hora-actual" class="display-6 fw-bold" style="color: #0d1b2a;">
                            <!-- La hora se actualizará con JavaScript -->
                        </div>
                        <small id="fecha-actual" class="text-muted"></small>
                    </div>
                    <hr>
                    <div class="d-flex justify-content-between">
                        <span>Estado:</span>
                        <span class="badge" style="background-color: #14532d; color: white;">En línea</span>
                    </div>
                    <div class="d-flex justify-content-between mt-2">
                        <span>Turno:</span>
                        <span id="turno-actual">Mañana</span>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header" style="background-color: #0d1b2a; color: white;">

                    <h5 class="mb-0"><i class="fas fa-history me-2"></i>Últimos Registros</h5>
                </div>
                <div class="card-body">
                    <div id="ultimos-registros">
                        <div class="text-center text-muted py-3">
                            <i class="fas fa-history fa-2x mb-2"></i>
                            <p class="mb-0">No hay registros recientes</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
<script>
let html5QrCode;
let isScanning = false;

// Inicializar cuando la página cargue
document.addEventListener('DOMContentLoaded', function() {
    console.log('Página cargada, mostrando opciones...');
    
    // Mostrar opciones para subir archivo o usar cámara
    mostrarOpcionesQR();
});

function mostrarOpcionesQR() {
    const scannerPlaceholder = document.getElementById('scanner-placeholder');
    if (scannerPlaceholder) {
        scannerPlaceholder.innerHTML = `
            <div class="text-center p-3">
                <i class="fas fa-qrcode text-muted mb-3" style="font-size: 3rem;"></i>
                <h5 class="text-muted mb-3">Escaneo de Código QR</h5>
                
                <div class="mb-3">
                    <button class="btn btn-primary btn-lg w-100 mb-2" onclick="intentarCamara()">
                        <i class="fas fa-camera me-2"></i>Usar Cámara
                    </button>
                    
                    <button class="btn btn-outline-secondary btn-lg w-100" onclick="subirArchivoQR()">
                        <i class="fas fa-upload me-2"></i>Subir Imagen QR
                    </button>
                </div>
                
                <div class="mt-3">
                    <small class="text-muted">
                        <strong>Opciones:</strong><br>
                        • <strong>Cámara:</strong> Escanea en tiempo real<br>
                        • <strong>Imagen:</strong> Sube foto de código QR
                    </small>
                </div>
            </div>
        `;
    }
}

function intentarCamara() {
    const scannerPlaceholder = document.getElementById('scanner-placeholder');
    if (scannerPlaceholder) {
        scannerPlaceholder.innerHTML = `
            <div class="text-center">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Cargando...</span>
                </div>
                <p class="mt-2 text-muted">Iniciando cámara...</p>
                <small class="text-muted">Acepte el permiso cuando se solicite</small>
            </div>
        `;
    }
    
    // Limpiar instancia anterior
    if (html5QrCode) {
        try {
            html5QrCode.clear();
        } catch(e) {
            console.log('Limpiando instancia...');
        }
    }
    
    // Crear nueva instancia
    html5QrCode = new Html5Qrcode("scanner-container");
    
    // Configuración
    const config = {
        fps: 10,
        qrbox: { width: 250, height: 250 }
    };
    
    // Intentar iniciar cámara
    html5QrCode.start(
        { facingMode: "environment" },
        config,
        onScanSuccess,
        onScanFailure
    ).then(() => {
        isScanning = true;
        console.log("✅ Cámara iniciada");
        if (scannerPlaceholder) {
            scannerPlaceholder.style.display = 'none';
        }
    }).catch(err => {
        console.error("❌ Error cámara:", err);
        // Volver a opciones
        mostrarOpcionesQR();
        mostrarMensaje('No se pudo acceder a la cámara. Usa "Subir Imagen QR"', 'warning');
    });
}

function subirArchivoQR() {
    const scannerContainer = document.getElementById('scanner-container');
    if (scannerContainer) {
        scannerContainer.innerHTML = `
            <div class="text-center p-4">
                <i class="fas fa-upload text-muted mb-3" style="font-size: 3rem;"></i>
                <h5 class="mb-3">Subir Imagen de Código QR</h5>
                <p class="text-muted mb-3">Selecciona una imagen que contenga un código QR</p>
                
                <input type="file" id="qr-file-input" accept="image/*" class="d-none">
                <button class="btn btn-primary btn-lg" onclick="document.getElementById('qr-file-input').click()">
                    <i class="fas fa-folder-open me-2"></i>Seleccionar Imagen
                </button>
                
                <div class="mt-3" id="upload-result"></div>
            </div>
        `;
        
        // Asignar evento al input de archivo
        document.getElementById('qr-file-input').addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (file) {
                escanearImagenQR(file);
            }
        });
    }
}

function escanearImagenQR(file) {
    const uploadResult = document.getElementById('upload-result');
    if (uploadResult) {
        uploadResult.innerHTML = `
            <div class="text-center">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Escaneando...</span>
                </div>
                <p class="mt-2 text-muted">Escaneando imagen...</p>
            </div>
        `;
    }
    
    // Limpiar instancia si existe
    if (html5QrCode) {
        try {
            html5QrCode.clear();
        } catch(e) {
            console.log('Limpiando instancia...');
        }
    }
    
    // Crear nueva instancia para archivo
    html5QrCode = new Html5Qrcode("scanner-container");
    
    // Escanear archivo
    html5QrCode.scanFile(file, true)
        .then(decodedText => {
            console.log("✅ QR escaneado de imagen:", decodedText);
            mostrarMensaje('Código QR escaneado de imagen', 'success');
            procesarQR(decodedText);
        })
        .catch(err => {
            console.error("❌ Error escaneando imagen:", err);
            if (uploadResult) {
                uploadResult.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        No se pudo escanear el código QR de la imagen
                    </div>
                    <button class="btn btn-primary" onclick="subirArchivoQR()">
                        <i class="fas fa-redo me-2"></i>Reintentar
                    </button>
                `;
            }
        });
}

function onScanSuccess(decodedText, decodedResult) {
    console.log("✅ Código QR escaneado:", decodedText);
    
    if (isScanning) {
        isScanning = false;
        procesarQR(decodedText);
        setTimeout(() => {
            isScanning = true;
        }, 3000);
    }
}

function onScanFailure(error) {
    // Silencioso
    console.warn(`Escaneo fallido: ${error}`);
}

function procesarQR(codigoQR) {
    console.log("Procesando QR:", codigoQR);
    mostrarMensaje('Procesando...', 'info');
    
    fetch('/api/scan', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            codigo_qr: codigoQR
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            mostrarMensaje(data.message, 'success');
            actualizarUltimosRegistros(data.data);
        } else if (data.status === 'duplicado') {
            mostrarMensaje(data.message, 'warning');
        } else {
            mostrarMensaje(data.message || 'Error desconocido', 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        mostrarMensaje('Error de conexión', 'danger');
    });
}

function mostrarMensaje(mensaje, tipo) {
    const alertDiv = document.createElement('div');
    const tipoBootstrap = tipo === 'error' ? 'danger' : tipo === 'warning' ? 'warning' : tipo;
    alertDiv.className = `alert alert-${tipoBootstrap} alert-dismissible fade show position-fixed`;
    alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px; max-width: 90%; margin: 10px;';
    alertDiv.innerHTML = `
        ${mensaje}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(alertDiv);
    
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 5000);
}

function actualizarUltimosRegistros(data) {
    if (!data) return;
    
    const registrosDiv = document.getElementById('ultimos-registros');
    if (registrosDiv) {
        registrosDiv.innerHTML = `
            <div class="d-flex align-items-center mb-3 p-2 border rounded">
                <div class="flex-shrink-0">
                    <i class="fas fa-user-circle fa-2x text-primary"></i>
                </div>
                <div class="flex-grow-1 ms-3">
                    <h6 class="mb-0">${data.empleado.nombre}</h6>
                    <small class="text-muted">ID: ${data.empleado.id}</small>
                    <div class="mt-1">
                        <span class="badge bg-success">Registrado</span>
                    </div>
                </div>
            </div>
        `;
    }
}

// Actualizar hora
function actualizarHora() {
    const ahora = new Date();
    const horaElement = document.getElementById('hora-actual');
    const fechaElement = document.getElementById('fecha-actual');
    
    if (horaElement) {
        horaElement.textContent = ahora.toLocaleTimeString('es-ES', {hour12: false});
    }
    
    if (fechaElement) {
        fechaElement.textContent = ahora.toLocaleDateString('es-ES', {
            weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
        });
    }
    
    const hora = ahora.getHours();
    let turno = 'Noche';
    if (hora >= 6 && hora < 13) turno = 'Mañana';
    else if (hora >= 13 && hora < 19) turno = 'Tarde';
    
    const turnoElement = document.getElementById('turno-actual');
    if (turnoElement) {
        turnoElement.textContent = turno;
    }
}

setInterval(actualizarHora, 1000);
actualizarHora();

document.addEventListener('DOMContentLoaded', function() {
    actualizarHora();
});
</script>

 <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="row">
                <div class="col-md-6">
                    <h5><i class="fas fa-qrcode me-2"></i>Sistema de Asistencia QR</h5>
                    <p>Sistema avanzado de control de asistencia mediante códigos QR para múltiples empresas.</p>
                </div>
                <div class="col-md-3">
                    <h5>Enlaces</h5>
                    <ul class="list-unstyled">
                        <li><a href="{{ url_for('index') }}" class="text-white">Inicio</a></li>
                        <li><a href="{{ url_for('scan_qr') }}" class="text-white">Escanear QR</a></li>
                        <li><a href="{{ url_for('reports') }}" class="text-white">Reportes</a></li>
                    </ul>
                </div>
                <div class="col-md-3">
                    <h5>Contacto</h5>
                    <p><i class="fas fa-envelope me-2"></i>djjhotamix@gmail.com</p>
                    <p><i class="fas fa-phone me-2"></i>+51 916 921 168</p>
                </div>
            </div>
            <hr class="bg-light">
            <div class="text-center">
                <p>&copy; 2025 Sistema de Asistencia QR. Todos los derechos reservados.</p>
            </div>
        </div>
    </footer>
{% endblock %}