{% extends "base.html" %}

{% block title %}Escanear QR{% endblock %}

{% block content %}
<style>
body {
    background: #f8f9fa;
    margin: 0;
    padding: 0;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
}

/* Layout centrado vertical */
.scan-wrapper {
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    padding: 1rem;
}

/* Barra superior minimalista */
.navbar-scan {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: white;
    padding: 1rem 1.5rem;
    border-radius: 12px;
    margin-bottom: 1.5rem;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
}

.logo-section {
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.logo-icon {
    width: 36px;
    height: 36px;
    background: #14532d;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
}

.logo-text {
    font-size: 1.125rem;
    font-weight: 700;
    color: #0d1b2a;
}

.time-badge {
    background: #f1f5f9;
    padding: 0.5rem 1rem;
    border-radius: 8px;
    font-size: 0.875rem;
    font-weight: 600;
    color: #0d1b2a;
}

/* Contenedor principal - DISE√ëO HORIZONTAL */
.main-container {
    flex: 1;
    display: flex;
    gap: 1.5rem;
    max-width: 1400px;
    width: 100%;
    margin: 0 auto;
}

/* Panel izquierdo - Stats compactas */
.left-panel {
    flex: 0 0 280px;
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.stat-box {
    background: white;
    padding: 1.25rem;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
}

.stat-box-header {
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: #64748b;
    font-weight: 600;
    margin-bottom: 0.75rem;
}

.stat-box-value {
    font-size: 1.875rem;
    font-weight: 700;
    color: #0d1b2a;
    font-family: 'Courier New', monospace;
}

.stat-box-label {
    font-size: 0.8125rem;
    color: #64748b;
    margin-top: 0.25rem;
}

.status-indicator {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-top: 0.75rem;
    padding: 0.5rem;
    background: #ecfdf5;
    border-radius: 6px;
}

.status-dot {
    width: 6px;
    height: 6px;
    background: #10b981;
    border-radius: 50%;
}

.status-text {
    font-size: 0.8125rem;
    color: #14532d;
    font-weight: 600;
}

/* Panel central - Esc√°ner GRANDE */
.center-panel {
    flex: 1;
    display: flex;
    flex-direction: column;
}

.scanner-main-card {
    background: white;
    border-radius: 16px;
    padding: 2rem;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    flex: 1;
    display: flex;
    flex-direction: column;
}

.scanner-title-section {
    text-align: center;
    margin-bottom: 1.5rem;
}

.scanner-title-section h2 {
    font-size: 1.5rem;
    font-weight: 700;
    color: #0d1b2a;
    margin: 0 0 0.5rem 0;
}

.scanner-subtitle {
    font-size: 0.9375rem;
    color: #64748b;
}

/* √Årea de escaneo - HEXAGONAL */
.scanner-area {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
    min-height: 450px;
}

.scanner-hexagon {
    width: 100%;
    max-width: 450px;
    aspect-ratio: 1;
    background: #f8fafc;
    border: 3px solid #e2e8f0;
    border-radius: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
    overflow: hidden;
}

.scanner-container {
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
}

#scanner-video {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: none;
    border-radius: 20px;
}

.scanner-placeholder {
    text-align: center;
    padding: 2rem;
}

.qr-mega-icon {
    width: 100px;
    height: 100px;
    background: #14532d;
    border-radius: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 1.5rem;
}

.qr-mega-icon i {
    font-size: 3.5rem;
    color: white;
}

.scanner-placeholder h3 {
    font-size: 1.25rem;
    color: #0d1b2a;
    font-weight: 700;
    margin-bottom: 0.75rem;
}

.scanner-placeholder p {
    color: #64748b;
    font-size: 0.9375rem;
    margin-bottom: 2rem;
}

/* Botones horizontales */
.action-buttons {
    display: flex;
    gap: 1rem;
    justify-content: center;
}

.btn-action {
    padding: 1rem 2rem;
    border-radius: 10px;
    border: none;
    font-weight: 600;
    font-size: 0.9375rem;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.btn-camera {
    background: #14532d;
    color: white;
}

.btn-camera:hover {
    background: #0d1b2a;
    transform: scale(1.02);
}

.btn-upload {
    background: white;
    color: #0d1b2a;
    border: 2px solid #e2e8f0;
}

.btn-upload:hover {
    border-color: #14532d;
    color: #14532d;
    transform: scale(1.02);
}

/* Tip box abajo del esc√°ner */
.tip-box {
    margin-top: 1.5rem;
    padding: 1rem 1.25rem;
    background: #f8fafc;
    border-left: 3px solid #14532d;
    border-radius: 8px;
    display: flex;
    gap: 1rem;
    align-items: start;
}

.tip-icon {
    width: 32px;
    height: 32px;
    background: white;
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #14532d;
    flex-shrink: 0;
}

.tip-content {
    flex: 1;
}

.tip-content strong {
    display: block;
    color: #0d1b2a;
    margin-bottom: 0.25rem;
    font-size: 0.875rem;
}

.tip-content p {
    color: #64748b;
    font-size: 0.8125rem;
    margin: 0;
    line-height: 1.5;
}

/* Panel derecho - Actividad */
.right-panel {
    flex: 0 0 300px;
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.activity-card {
    background: white;
    border-radius: 12px;
    padding: 1.25rem;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
}

.activity-header {
    font-size: 0.875rem;
    font-weight: 700;
    color: #0d1b2a;
    margin-bottom: 1rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.activity-list {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
}

.activity-item {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.75rem;
    background: #f8fafc;
    border-radius: 8px;
}

.activity-avatar {
    width: 36px;
    height: 36px;
    background: #14532d;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    flex-shrink: 0;
}

.activity-info {
    flex: 1;
    min-width: 0;
}

.activity-name {
    font-size: 0.875rem;
    font-weight: 600;
    color: #0d1b2a;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.activity-id {
    font-size: 0.75rem;
    color: #64748b;
}

.activity-badge {
    background: #10b981;
    color: white;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-size: 0.6875rem;
    font-weight: 600;
    flex-shrink: 0;
}

.empty-activity {
    text-align: center;
    padding: 2rem 1rem;
    color: #94a3b8;
}

.empty-activity i {
    font-size: 2.5rem;
    margin-bottom: 0.75rem;
    opacity: 0.3;
}

.empty-activity p {
    font-size: 0.875rem;
    margin: 0;
}

/* Footer compacto */
.footer-compact {
    margin-top: 2rem;
    padding: 1.5rem;
    background: white;
    border-radius: 12px;
    text-align: center;
}

.footer-links {
    display: flex;
    justify-content: center;
    gap: 2rem;
    margin-bottom: 1rem;
    flex-wrap: wrap;
}

.footer-links a {
    color: #64748b;
    text-decoration: none;
    font-size: 0.875rem;
    font-weight: 500;
}

.footer-links a:hover {
    color: #14532d;
}

.footer-copy {
    color: #94a3b8;
    font-size: 0.8125rem;
}

/* RESPONSIVE TOTAL */
@media (max-width: 1200px) {
    .main-container {
        flex-direction: column;
    }
    
    .left-panel,
    .right-panel {
        flex: 0 0 auto;
        width: 100%;
    }
    
    .left-panel {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
    }
}

@media (max-width: 768px) {
    .scan-wrapper {
        padding: 0.75rem;
    }
    
    .navbar-scan {
        flex-direction: column;
        gap: 0.75rem;
        padding: 1rem;
    }
    
    .scanner-hexagon {
        max-width: 100%;
        min-height: 320px;
    }
    
    .qr-mega-icon {
        width: 70px;
        height: 70px;
    }
    
    .qr-mega-icon i {
        font-size: 2.5rem;
    }
    
    .action-buttons {
        flex-direction: column;
        width: 100%;
    }
    
    .btn-action {
        width: 100%;
        justify-content: center;
    }
    
    .scanner-main-card {
        padding: 1.25rem;
    }
    
    .left-panel {
        grid-template-columns: 1fr;
    }
    
    .footer-links {
        flex-direction: column;
        gap: 0.75rem;
    }
}

@media (max-width: 480px) {
    .scanner-hexagon {
        min-height: 280px;
    }
    
    .scanner-title-section h2 {
        font-size: 1.25rem;
    }
    
    .stat-box-value {
        font-size: 1.5rem;
    }
}

/* Canvas QR */
#qr-canvas {
    width: 100% !important;
    height: auto !important;
}
</style>

<div class="scan-wrapper">
    <!-- Navbar superior -->
    <nav class="navbar-scan">
        <div class="logo-section">
            <div class="logo-icon">
                <i class="fas fa-clock"></i>
            </div>
            <span class="logo-text" id="nav-time"></span>
        </div>
        <div class="time-badge">
            <i class="fas fa-calendar-day me-2"></i>
            <span id="nav-date"></span>
        </div>
    </nav>

    <!-- Contenedor principal horizontal -->
    <div class="main-container">
        <!-- Panel izquierdo: Stats -->
        <aside class="left-panel">
            <div class="stat-box">
                <div class="stat-box-header">Hora actual</div>
                <div id="hora-principal" class="stat-box-value"></div>
                <div id="fecha-principal" class="stat-box-label"></div>
            </div>
            
            <div class="stat-box">
                <div class="stat-box-header">Turno</div>
                <div id="turno-principal" class="stat-box-value" style="font-size: 1.5rem;">Ma√±ana</div>
                <div class="status-indicator">
                    <span class="status-dot"></span>
                    <span class="status-text">Sistema operativo</span>
                </div>
            </div>
        </aside>

        <!-- Panel central: Esc√°ner -->
        <main class="center-panel">
            <div class="scanner-main-card">
                <div class="scanner-title-section">
                    <h2>Registrar Asistencia</h2>
                    <p class="scanner-subtitle">Escanea o sube el c√≥digo QR del empleado</p>
                </div>

                <div class="scanner-area">
                    <div class="scanner-hexagon">
                        <div class="scanner-container" id="scanner-container">
                            <div id="scanner-placeholder" class="scanner-placeholder"></div>
                            <video id="scanner-video"></video>
                        </div>
                    </div>
                </div>

                <div class="tip-box">
                    <div class="tip-icon">
                        <i class="fas fa-info-circle"></i>
                    </div>
                    <div class="tip-content">
                        <strong>Consejo de uso</strong>
                        <p>Para mejores resultados, mant√©n el c√≥digo QR centrado y a una distancia de 15-20 cm de la c√°mara.</p>
                    </div>
                </div>
            </div>
        </main>

        <!-- Panel derecho: Actividad -->
        <aside class="right-panel">
            <div class="activity-card">
                <div class="activity-header">Actividad reciente</div>
                <div id="activity-list">
                    <div class="empty-activity">
                        <i class="fas fa-inbox"></i>
                        <p>Sin registros</p>
                    </div>
                </div>
            </div>
        </aside>
    </div>

    <!-- Footer -->
    <footer class="footer-compact">
        <div class="footer-links">
            <a href="{{ url_for('index') }}">Inicio</a>
            <a href="{{ url_for('scan_qr') }}">Escanear</a>
            <a href="{{ url_for('reports') }}">Reportes</a>
            <a href="mailto:djjhotamix@gmail.com">Contacto</a>
        </div>
        <div class="footer-copy">
            ¬© 2025 Sistema de Asistencia QR
        </div>
    </footer>
</div>

{% endblock %}

{% block scripts %}
<script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
<script>
let html5QrCode;
let isScanning = false;

// Sonido de escaneo exitoso
const successSound = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTcIGmi78OScTgwOUKrj8LNgGgU7k9n0yXoyBS1+zPLaizsKGGS57OihUBELTKXh8LJcHAU7ldr0yHgwBSh+y/DblDwLF2G56+mjTxENTqni77RfHQU+mNvzzn0vBSF1xe/glEILFlq16OmnUBMMUKvm8LVjHAY+mdz0z3wvBCB0xO7fk0EKEM==');

document.addEventListener('DOMContentLoaded', function() {
    mostrarOpcionesQR();
    actualizarHora();
});

function mostrarOpcionesQR() {
    const placeholder = document.getElementById('scanner-placeholder');
    if (placeholder) {
        placeholder.innerHTML = `
            <div class="qr-mega-icon">
                <i class="fas fa-qrcode"></i>
            </div>
            
            <h3>M√©todo de escaneo</h3>
            <p>Selecciona c√≥mo deseas escanear el c√≥digo QR</p>
            
            <div class="action-buttons">
                <button class="btn-action btn-camera" onclick="iniciarCamara()">
                    <i class="fas fa-video"></i>
                    Usar c√°mara
                </button>
                
                <button class="btn-action btn-upload" onclick="subirImagen()">
                    <i class="fas fa-image"></i>
                    Subir imagen
                </button>
            </div>
        `;
    }
}

function iniciarCamara() {
    const placeholder = document.getElementById('scanner-placeholder');
    if (placeholder) {
        placeholder.innerHTML = `
            <div style="text-align: center; padding: 2rem;">
                <div class="spinner-border" style="color: #14532d; width: 3rem; height: 3rem; margin-bottom: 1rem;"></div>
                <p style="color: #0d1b2a; font-weight: 600; margin: 0;">Activando c√°mara...</p>
            </div>
        `;
    }
    
    if (html5QrCode) {
        try { html5QrCode.clear(); } catch(e) {}
    }
    
    html5QrCode = new Html5Qrcode("scanner-container");
    
    html5QrCode.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: { width: 250, height: 250 } },
        onScanSuccess,
        onScanFailure
    ).then(() => {
        isScanning = true;
        console.log("‚úÖ C√°mara iniciada");
        if (placeholder) placeholder.style.display = 'none';
    }).catch(err => {
        console.error("‚ùå Error c√°mara:", err);
        mostrarOpcionesQR();
        mostrarAlerta('No se pudo acceder a la c√°mara. Intenta "Subir imagen"', 'warning');
    });
}

function subirImagen() {
    const container = document.getElementById('scanner-container');
    if (container) {
        container.innerHTML = `
            <div style="text-align: center; padding: 2rem;">
                <div class="qr-mega-icon" style="margin-bottom: 1.5rem;">
                    <i class="fas fa-cloud-upload-alt"></i>
                </div>
                
                <h3 style="color: #0d1b2a; margin-bottom: 0.75rem;">Subir c√≥digo QR</h3>
                <p style="color: #64748b; margin-bottom: 2rem;">Selecciona una imagen</p>
                
                <input type="file" id="file-input" accept="image/*" class="d-none">
                <button class="btn-action btn-camera" onclick="document.getElementById('file-input').click()" style="margin: 0 auto;">
                    <i class="fas fa-folder-open"></i>
                    Seleccionar archivo
                </button>
                
                <div id="upload-status" style="margin-top: 1.5rem;"></div>
            </div>
        `;
        
        document.getElementById('file-input').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) procesarImagen(file);
        });
    }
}

function procesarImagen(file) {
    const status = document.getElementById('upload-status');
    if (status) {
        status.innerHTML = `
            <div class="spinner-border" style="color: #14532d; width: 2.5rem; height: 2.5rem;"></div>
            <p style="color: #64748b; margin-top: 1rem;">Escaneando...</p>
        `;
    }
    
    if (html5QrCode) {
        try { html5QrCode.clear(); } catch(e) {}
    }
    
    html5QrCode = new Html5Qrcode("scanner-container");
    
    html5QrCode.scanFile(file, true)
        .then(text => {
            mostrarAlerta('C√≥digo detectado', 'success');
            procesarQR(text);
        })
        .catch(err => {
            if (status) {
                status.innerHTML = `
                    <div style="background: #fee2e2; color: #991b1b; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                        <i class="fas fa-times-circle me-2"></i>
                        No se detect√≥ un c√≥digo QR
                    </div>
                    <button class="btn-action btn-upload" onclick="subirImagen()" style="margin: 0 auto;">
                        <i class="fas fa-redo"></i>
                        Reintentar
                    </button>
                `;
            }
        });
}

function onScanSuccess(text) {
    if (isScanning) {
        isScanning = false; // Bloqueamos inmediatamente
        
        // Reproducir sonido de √©xito
        successSound.play().catch(e => console.log('No se pudo reproducir sonido'));
        
        procesarQR(text);
        
        // üî• CAMBIO AQU√ç: Aumentamos a 5 segundos (5000) para dar tiempo a retirar el QR
        setTimeout(() => { 
            isScanning = true; 
            console.log("Esc√°ner reactivado");
        }, 5000); 
    }
}

function onScanFailure(error) {
    // Silencioso
}
function procesarQR(codigo) {
    mostrarAlerta('Procesando...', 'info');
    
    fetch('/api/scan', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ codigo_qr: codigo })
    })
    .then(r => r.json())
    .then(data => {
        console.log("Respuesta servidor:", data); // Para depurar

        if (data.status === 'success') {
            // √âXITO REAL (Entrada o Salida registrada)
            successSound.play().catch(e => console.log('No se pudo reproducir sonido'));
            mostrarAlerta(data.message, 'success');
            actualizarActividad(data.data);
            
        } else if (data.status === 'duplicado') {
            // DUPLICADO (Ya escane√≥ hace milisegundos - manejado por repositorio)
            mostrarAlerta(data.message, 'warning');
            
        } else {
            // üî• AQU√ç CAPTURAMOS EL "ESPERA 5 MINUTOS"
            // Si el backend devuelve status="success" pero actualizado=False (mi c√≥digo Python anterior)
            // O si devuelve status="error"
            
            // Si el mensaje contiene "Espera", lo mostramos como advertencia amarilla, no roja
            if (data.message && data.message.includes("Espera")) {
                mostrarAlerta(data.message, 'warning');
            } else {
                mostrarAlerta(data.message || 'Error desconocido', 'danger');
            }
        }
    })
    .catch(err => {
        console.error(err);
        mostrarAlerta('Error de conexi√≥n con el servidor', 'danger');
    });
}


function mostrarAlerta(msg, tipo) {
    const colores = {
        'success': { bg: '#ecfdf5', color: '#14532d', border: '#10b981' },
        'danger': { bg: '#fee2e2', color: '#991b1b', border: '#ef4444' },
        'warning': { bg: '#fef3c7', color: '#92400e', border: '#f59e0b' },
        'info': { bg: '#dbeafe', color: '#1e40af', border: '#3b82f6' }
    };
    
    const c = colores[tipo] || colores.info;
    const div = document.createElement('div');
    
    div.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 9999;
        min-width: 300px;
        background: ${c.bg};
        color: ${c.color};
        padding: 1rem 1.25rem;
        border-radius: 10px;
        border-left: 4px solid ${c.border};
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        display: flex;
        align-items: center;
        gap: 0.75rem;
    `;
    
    div.innerHTML = `
        <span style="flex: 1; font-weight: 500;">${msg}</span>
        <button onclick="this.parentElement.remove()" style="background: none; border: none; color: inherit; cursor: pointer; font-size: 1.125rem; opacity: 0.7;">
            <i class="fas fa-times"></i>
        </button>
    `;
    
    document.body.appendChild(div);
    setTimeout(() => { if (div.parentNode) div.remove(); }, 5000);
}

function actualizarActividad(data) {
    if (!data) return;
    
    const list = document.getElementById('activity-list');
    if (list) {
        list.innerHTML = `
            <div class="activity-list">
                <div class="activity-item">
                    <div class="activity-avatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="activity-info">
                        <div class="activity-name">${data.empleado.nombre}</div>
                        <div class="activity-id">ID: ${data.empleado.id}</div>
                    </div>
                    <div class="activity-badge">
                        <i class="fas fa-check"></i>
                    </div>
                </div>
            </div>
        `;
    }
}

function actualizarHora() {
    const now = new Date();
    
    const hEl = document.getElementById('hora-principal');
    const fEl = document.getElementById('fecha-principal');
    const nEl = document.getElementById('nav-time');
    const ndEl = document.getElementById('nav-date');
    
    if (hEl) hEl.textContent = now.toLocaleTimeString('es-ES', {hour12: false});
    if (nEl) nEl.textContent = now.toLocaleTimeString('es-ES', {hour: '2-digit', minute: '2-digit'});
    if (fEl) fEl.textContent = now.toLocaleDateString('es-ES', {weekday: 'long', day: 'numeric', month: 'long'});
    if (ndEl) ndEl.textContent = now.toLocaleDateString('es-ES', {day: 'numeric', month: 'short', year: 'numeric'});
    
    const h = now.getHours();
    let turno = 'Noche';
    if (h >= 6 && h < 13) turno = 'Ma√±ana';
    else if (h >= 13 && h < 19) turno = 'Tarde';
    
    const tEl = document.getElementById('turno-principal');
    if (tEl) tEl.textContent = turno;
}

setInterval(actualizarHora, 1000);
</script>
{% endblock %}